<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì£¼ë¬¸ ì§„í–‰ í˜„í™© â€” ê¸°ë…ì¼ ì˜ìƒ</title>
<style>
:root {
  --purple: #a78bfa;
  --purple-dark: #7c3aed;
  --green: #34d399;
  --bg: #0f0f14;
  --card: #1a1a2e;
  --border: #2d2d44;
  --text: #e2e8f0;
  --muted: #94a3b8;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif;
       background: var(--bg); color: var(--text); min-height: 100vh;
       display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
       padding: 40px 20px; }
.logo { font-size: 14px; font-weight: 700; color: var(--purple); margin-bottom: 32px;
        letter-spacing: .5px; }
.card { background: var(--card); border: 1px solid var(--border); border-radius: 20px;
        padding: 36px 32px; width: 100%; max-width: 480px; }
.card h1 { font-size: 20px; font-weight: 700; margin-bottom: 6px; }
.card .sub { font-size: 14px; color: var(--muted); margin-bottom: 28px; }

/* ìƒíƒœ ë°°ì§€ */
.status-badge {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 10px 18px; border-radius: 30px; font-size: 14px; font-weight: 700;
  margin-bottom: 24px;
}
.badge-PENDING    { background:#1e1b4b; color:#a78bfa; }
.badge-PAID       { background:#1a2e2b; color:#34d399; }
.badge-PROCESSING { background:#1e2a3b; color:#60a5fa; }
.badge-COMPLETED  { background:#14291e; color:#4ade80; }
.badge-FAILED     { background:#2d1515; color:#f87171; }

/* íƒ€ì„ë¼ì¸ */
.timeline { list-style: none; padding: 0; margin: 24px 0; }
.timeline li { display: flex; align-items: flex-start; gap: 14px; padding: 10px 0;
               border-left: 2px solid var(--border); padding-left: 20px; position: relative;
               margin-left: 8px; }
.timeline li::before { content: ''; position: absolute; left: -5px; top: 14px;
                        width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
.timeline li.done::before { background: var(--green); }
.timeline li.active::before { background: var(--purple); box-shadow: 0 0 8px var(--purple); }
.timeline li.done { border-color: #1e3a2e; }
.step-title { font-size: 14px; font-weight: 600; }
.step-desc  { font-size: 12px; color: var(--muted); margin-top: 2px; }

/* ë‹¤ìš´ë¡œë“œ ë°•ìŠ¤ */
.download-box { background: #0f2d1a; border: 1px solid #1e5c34; border-radius: 12px;
                padding: 20px; margin: 20px 0; text-align: center; }
.download-box .title { font-size: 15px; font-weight: 700; color: var(--green); margin-bottom: 8px; }
.download-box .exp { font-size: 12px; color: var(--muted); margin-bottom: 16px; }
.download-btn { display: inline-block; background: var(--purple-dark); color: #fff;
                padding: 12px 32px; border-radius: 8px; font-size: 15px; font-weight: 700;
                text-decoration: none; transition: opacity .2s; }
.download-btn:hover { opacity: .85; }
.refresh-btn { background: none; border: 1px solid var(--border); color: var(--muted);
               padding: 8px 20px; border-radius: 8px; font-size: 13px; cursor: pointer;
               margin-top: 10px; transition: border-color .2s; }
.refresh-btn:hover { border-color: var(--purple); color: var(--text); }

/* ì…ë ¥ í¼ (orderId ì—†ì„ ë•Œ) */
.lookup-form { display: flex; flex-direction: column; gap: 12px; }
.lookup-form input { background: #0f0f14; border: 1px solid var(--border); color: var(--text);
                     padding: 12px 16px; border-radius: 8px; font-size: 15px; outline: none; }
.lookup-form input:focus { border-color: var(--purple); }
.lookup-btn { background: var(--purple-dark); color: #fff; border: none; padding: 13px;
              border-radius: 8px; font-size: 15px; font-weight: 700; cursor: pointer; }

/* ì‹¤íŒ¨ ë°•ìŠ¤ */
.fail-box { background: #2d1515; border: 1px solid #5c2020; border-radius: 12px;
            padding: 20px; margin: 20px 0; }
.fail-box .title { font-size: 15px; font-weight: 700; color: #f87171; margin-bottom: 6px; }
.fail-box p { font-size: 13px; color: var(--muted); }
.contact-btn { display: inline-block; background: #1f2937; color: var(--text);
               padding: 8px 20px; border-radius: 8px; font-size: 13px; text-decoration: none;
               margin-top: 12px; }

/* ë¡œë”© */
.loading { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 32px 0; }
.spinner { width: 32px; height: 32px; border: 3px solid var(--border);
           border-top-color: var(--purple); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

footer { margin-top: 32px; font-size: 12px; color: #374151; text-align: center; }
</style>
</head>
<body>
<div class="logo">âœ¨ ê¸°ë…ì¼ ì˜ìƒ ì„œë¹„ìŠ¤</div>

<div class="card">
  <!-- ë¡œë”© -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div style="font-size:14px;color:var(--muted)">ì¡°íšŒ ì¤‘...</div>
  </div>

  <!-- ì£¼ë¬¸ë²ˆí˜¸ ì…ë ¥ í¼ -->
  <div id="form-section" style="display:none">
    <h1>ì£¼ë¬¸ í˜„í™© ì¡°íšŒ</h1>
    <p class="sub">ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì‹œë©´ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    <div class="lookup-form">
      <input type="number" id="order-input" placeholder="ì£¼ë¬¸ë²ˆí˜¸ (ì˜ˆ: 12)" min="1">
      <button class="lookup-btn" onclick="lookup()">ì¡°íšŒí•˜ê¸°</button>
    </div>
    <div id="form-error" style="font-size:13px;color:#f87171;margin-top:8px;display:none"></div>
  </div>

  <!-- ì£¼ë¬¸ ì •ë³´ -->
  <div id="order-section" style="display:none">
    <h1>ì£¼ë¬¸ ì§„í–‰ í˜„í™©</h1>
    <p class="sub" id="order-title"></p>

    <!-- ìƒíƒœ ë°°ì§€ -->
    <div id="status-badge"></div>

    <!-- íƒ€ì„ë¼ì¸ -->
    <ul class="timeline" id="timeline"></ul>

    <!-- ì™„ì„± ë‹¤ìš´ë¡œë“œ -->
    <div class="download-box" id="download-box" style="display:none">
      <div class="title">ğŸ¬ ì˜ìƒì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
      <div class="exp" id="expires-text"></div>
      <a id="download-link" class="download-btn" href="#" target="_blank">ğŸ“¥ ì˜ìƒ ë‹¤ìš´ë¡œë“œ</a>
      <br>
      <button class="refresh-btn" onclick="refreshUrl()">ë§í¬ ê°±ì‹  (ë§Œë£Œ ì‹œ)</button>
    </div>

    <!-- ì‹¤íŒ¨ ì•ˆë‚´ -->
    <div class="fail-box" id="fail-box" style="display:none">
      <div class="title">âš ï¸ ì œì‘ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</div>
      <p>ê³ ê°ì„¼í„°ë¡œ ì—°ë½ì£¼ì‹œë©´ ì‹ ì†íˆ ì²˜ë¦¬í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.<br>
         ê²°ì œí•˜ì‹  ê¸ˆì•¡ì€ ì „ì•¡ í™˜ë¶ˆí•´ ë“œë¦½ë‹ˆë‹¤.</p>
      <a href="https://open.kakao.com/placeholder" class="contact-btn">ğŸ’¬ ì¹´ì¹´ì˜¤í†¡ ë¬¸ì˜</a>
    </div>

    <!-- ìƒˆë¡œê³ ì¹¨ -->
    <div style="text-align:center;margin-top:20px" id="refresh-section">
      <button class="refresh-btn" onclick="loadOrder(currentOrderId)">ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
      <div style="font-size:12px;color:#374151;margin-top:6px" id="last-updated"></div>
    </div>
  </div>
</div>

<footer>ë¬¸ì˜: ì¹´ì¹´ì˜¤í†¡ @ê¸°ë…ì¼ì˜ìƒ Â· â“’ 2025 Anniversary Video</footer>

<script>
let currentOrderId = null;
let autoRefreshTimer = null;

const STATUS_LABELS = {
  PENDING:    { label: 'ì£¼ë¬¸ ì ‘ìˆ˜',   emoji: 'ğŸ“‹' },
  PAID:       { label: 'ê²°ì œ ì™„ë£Œ',   emoji: 'âœ…' },
  PROCESSING: { label: 'AI ì œì‘ ì¤‘',  emoji: 'ğŸ¬' },
  COMPLETED:  { label: 'ì œì‘ ì™„ë£Œ',   emoji: 'ğŸ‰' },
  FAILED:     { label: 'ì²˜ë¦¬ ì‹¤íŒ¨',   emoji: 'âš ï¸' },
};

const STEPS = [
  { key: 'PENDING',    title: 'ì£¼ë¬¸ & ê²°ì œ ì™„ë£Œ',  desc: 'ì‚¬ì§„ ì—…ë¡œë“œ ë° ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' },
  { key: 'PAID',       title: 'ì œì‘ ì¤€ë¹„ ì¤‘',       desc: 'AI ì˜ìƒ ì œì‘ì„ ì¤€ë¹„í•˜ê³  ìˆìŠµë‹ˆë‹¤.' },
  { key: 'PROCESSING', title: 'AI ì œì‘ ì§„í–‰ ì¤‘',    desc: 'ë³´í†µ 1~24ì‹œê°„ ì†Œìš”ë©ë‹ˆë‹¤.' },
  { key: 'COMPLETED',  title: 'ì œì‘ ì™„ë£Œ',           desc: 'ì˜ìƒì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”!' },
];
const STATUS_ORDER = ['PENDING', 'PAID', 'PROCESSING', 'COMPLETED'];

window.addEventListener('DOMContentLoaded', () => {
  const params = new URLSearchParams(window.location.search);
  const orderId = params.get('orderId') || params.get('id');

  if (orderId) {
    currentOrderId = parseInt(orderId);
    loadOrder(currentOrderId);
  } else {
    hide('loading');
    show('form-section');
  }
});

async function lookup() {
  const val = document.getElementById('order-input').value.trim();
  if (!val || isNaN(val)) {
    showFormError('ì£¼ë¬¸ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  currentOrderId = parseInt(val);
  hide('form-section');
  show('loading');
  loadOrder(currentOrderId);
}

async function loadOrder(orderId) {
  try {
    const resp = await fetch('/api/orders/' + orderId + '/status');
    if (!resp.ok) {
      if (resp.status === 400 || resp.status === 404) {
        hide('loading');
        show('form-section');
        showFormError('ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì£¼ë¬¸ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }
      throw new Error('ì„œë²„ ì˜¤ë¥˜');
    }
    const data = await resp.json();
    renderOrder(data);
  } catch(e) {
    hide('loading');
    show('form-section');
    showFormError('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

function renderOrder(data) {
  hide('loading');
  show('order-section');

  const status = data.status;
  const info = STATUS_LABELS[status] || { label: status, emoji: '?' };

  document.getElementById('order-title').textContent =
    'ì£¼ë¬¸ë²ˆí˜¸ #' + data.orderId;

  // ìƒíƒœ ë°°ì§€
  document.getElementById('status-badge').innerHTML =
    `<div class="status-badge badge-${status}">${info.emoji} ${info.label}</div>`;

  // íƒ€ì„ë¼ì¸
  const currentIdx = STATUS_ORDER.indexOf(status);
  const timeline = document.getElementById('timeline');
  timeline.innerHTML = STEPS.map((step, i) => {
    let cls = '';
    if (i < currentIdx || (status === 'COMPLETED' && i <= currentIdx)) cls = 'done';
    else if (i === currentIdx && status !== 'FAILED') cls = 'active';
    return `<li class="${cls}">
      <div>
        <div class="step-title">${step.title}</div>
        <div class="step-desc">${i === currentIdx ? step.desc : ''}</div>
      </div>
    </li>`;
  }).join('');

  // ì™„ì„± ì²˜ë¦¬
  if (status === 'COMPLETED' && data.downloadUrl) {
    show('download-box');
    document.getElementById('download-link').href = data.downloadUrl;
    document.getElementById('expires-text').textContent =
      'ë‹¤ìš´ë¡œë“œ ë§í¬ëŠ” 72ì‹œê°„ ë™ì•ˆ ìœ íš¨í•©ë‹ˆë‹¤.';
    clearAutoRefresh();
  } else if (status === 'FAILED') {
    show('fail-box');
    clearAutoRefresh();
  } else {
    // PROCESSING ì¤‘: 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    if (!autoRefreshTimer && (status === 'PROCESSING' || status === 'PAID')) {
      autoRefreshTimer = setInterval(() => loadOrder(currentOrderId), 30000);
    }
  }

  // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
  const now = new Date();
  document.getElementById('last-updated').textContent =
    'ë§ˆì§€ë§‰ ì¡°íšŒ: ' + now.toLocaleTimeString('ko-KR');
}

async function refreshUrl() {
  try {
    const resp = await fetch('/api/orders/' + currentOrderId + '/download-url', { method: 'POST' });
    if (!resp.ok) throw new Error();
    const data = await resp.json();
    document.getElementById('download-link').href = data.downloadUrl;
    document.getElementById('expires-text').textContent = 'ë§í¬ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤. 72ì‹œê°„ ìœ íš¨.';
    alert('ë‹¤ìš´ë¡œë“œ ë§í¬ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
  } catch(e) {
    alert('ë§í¬ ê°±ì‹ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
  }
}

function clearAutoRefresh() {
  if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
}

function show(id) { document.getElementById(id).style.display = 'block'; }
function hide(id) { document.getElementById(id).style.display = 'none'; }
function showFormError(msg) {
  const el = document.getElementById('form-error');
  el.textContent = msg; el.style.display = 'block';
}
</script>
</body>
</html>
